<%- include("partials/userHeader.ejs") -%>
    <!DOCTYPE html>
    <html lang="zxx">

    <head>
        <meta charset="UTF-8">
        <meta name="description" content="Male_Fashion Template">
        <meta name="keywords" content="Male_Fashion, unica, creative, html">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Male-Fashion | Template</title>

        <!-- Google Font -->
        <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
            rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

        <!-- Css Styles -->
        <link rel="stylesheet" href="/checkOut/css/bootstrap.min.css" type="text/css">
        <link rel="stylesheet" href="/checkOut/css/font-awesome.min.css" type="text/css">
        <link rel="stylesheet" href="/checkOut/css/elegant-icons.css" type="text/css">
        <link rel="stylesheet" href="/checkOut/css/magnific-popup.css" type="text/css">
        <link rel="stylesheet" href="/checkOut/css/nice-select.css" type="text/css">
        <link rel="stylesheet" href="/checkOut/css/owl.carousel.min.css" type="text/css">
        <link rel="stylesheet" href="/checkOut/css/slicknav.min.css" type="text/css">
        <link rel="stylesheet" href="/checkOut/css/style.css" type="text/css">



        <style>
            .my-actions { margin: 0 2em; }
.order-1 { order: 1; }
.order-2 { order: 2; }
.order-3 { order: 3; }

.right-gap {
  margin-right: auto;
}

        </style>
    </head>

    <body>




        <!-- Checkout Section Begin -->
        <section class="checkout spad">
            <div class="row">


                
                <div class="row col-md-7">
                    <div class="col-12">
                        <p style="padding-left: 20px;" >
                            <% if (Address) { %>
                                <% if (Address.address.length>0) { %>
                            <button class="btn btn-dark" type="button"        data-bs-toggle="collapse" data-parent="#accordion" data-bs-target="#collapseExample"
                                aria-expanded="true" aria-controls="collapseExample" style="width: 100%; display: none;"  >
                                Choose An address
                            </button>
                        </p>
                        <div  id="collapseExample">
                            <div class="card card-body">
                             
                
                                    <div class="card p-3 py-3 mt-3 card-1 text-center">
                
                                        <h4>Delivery Address</h4>
                
                                       
                
                                        <div class="p-3 card-2">
                
                                            <input type="radio" name="address" id="address"
                                                value="<%=Address.address[0].id %>" checked>
                
                
                
                
                                            <div class="p-3 card-child mt-4">
                
                
                                                <div class="d-flex flex-row align-items-center" style="
                                                    display: flex;
                                                    justify-content: space-between;">
                
                
                
                                                    <div class="d-flex flex-column ms-3"
                                                        style="font-size: 15px;">
                
                                                        <h6 class="fw-bold" style="
                                                      font-weight: 800;">
                                                            <%=Address.address[0].fullName %> ,
                                                                <%=Address.address[0].phone %>
                
                                                        </h6>
                                                        <span>
                                                            <%=Address.address[0].state %> ,
                                                                <%=Address.address[0].area %> , <br>
                                                                    <%=Address.address[0].buildingName %> ,
                
                
                                                    </div>
                
                                                    <div>
                
                                                        <button type="button"
                                                            class="btn btn-primary">Edit</button>
                
                                                        <button type="button" class="btn btn-danger"
                                                            onclick="deleteAddress(`<%=Address.address[0]._id%>`)">Delete</button>
                                                    </div>
                                                </div>
                
                
                
                
                
                
                
                                            </div>
                
                
                
                
                                        </div>
                                 
                                    </div>
                                
                            </div>
                        </div>
                        <% }%>
                           
                     <% } %> 
                        <% if (Address) { %>
                     <% if (Address.address.length>0) { %>
                      
                        
                        <p style="padding-left: 20px;">
                       
                            <button class="btn btn-dark" type="button"  style="width: 100%;"       data-bs-toggle="collapse" data-parent="#accordion" data-bs-target="#collapseExample0"
                                aria-expanded="false" aria-controls="collapseExample0" >
                                Choose An address
                            </button>
                        </p>
                        
                      
                        <% for( let i = 1; i < Address.address.length; i++ ) { %>
                            <div class="collapse" id="collapseExample0">
                                <div class="card card-body">
                                 
                    
                                        <div class="card p-3 py-3 mt-3 card-1 text-center">
                    
                                            <h4>Delivery Address</h4>
                    
                    
                    
                                            <div class="p-3 card-2">
                    
                                                <input type="radio" name="address" id="address"
                                                    value="<%=Address.address[i].id %>" re>
                    
                    
                    
                    
                                                <div class="p-3 card-child mt-4">
                    
                    
                                                    <div class="d-flex flex-row align-items-center" style="
                                                        display: flex;
                                                        justify-content: space-between;">
                    
                    
                    
                                                        <div class="d-flex flex-column ms-3"
                                                            style="font-size: 15px;">
                    
                                                            <h6 class="fw-bold" style="
                                                          font-weight: 800;">
                                                                <%=Address.address[i].fullName %> ,
                                                                    <%=Address.address[i].phone %>
                    
                                                            </h6>
                                                            <span>
                                                                <%=Address.address[i].state %> ,
                                                                    <%=Address.address[i].area %> , <br>
                                                                        <%=Address.address[i].buildingName %> ,
                    
                    
                                                        </div>
                    
                                                        <div>
                    
                                                            <button type="button"
                                                                class="btn btn-primary">Edit</button>
                    
                                                            <button type="button" class="btn btn-danger"
                                                                onclick="deleteAddress(`<%=Address.address[i]._id%>`)">Delete</button>
                                                        </div>
                                                    </div>
                    
                    
                    
                    
                    
                    
                    
                                                </div>
                    
                    
                    
                    
                                            </div>
                                        </div>
                                    
                                </div>
                            </div>
                        <% } %>
                        <% } %>
                           
                     <% } %> 
                        <button type="button" class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer" data-toggle="modal"
                            data-target="#exampleModal" style="
                            width: 188px;
                            height: 40px;
                            margin-left: 19px;">Add new Address</button>


                        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog"
                            aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content" style="margin-top: 200px;">
                                    <div class="modal-header">
                                        <h5 id="exampleModalLabel">Add Address</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" >
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="alert alert-danger" role="alert" id="error" style="display: none;">
                                       
                                          
                                          </div>
                                        <form action="/checkOutaddress" method="post" id="addform">

                                            <!-- 2 column grid layout with text inputs for the first and last names -->
                                            <div class="row mb-4">
                                                <div class="col">
                                                    <div class="form-outline">
                                                        <label class="form-label" for="form3Example1">Full
                                                            Name</label>
                                                        <input type="text" id="fullName" class="form-control"
                                                            name="fullName" required />

                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <div class="form-outline">
                                                        <label class="form-label" for="form3Example2">Phone</label>
                                                        <input type="tel" id="phone" class="form-control" name="phone"
                                                            required />

                                                    </div>
                                                </div>
                                            </div>


                                            <div class="form-outline mb-4">
                                                <label class="form-label" for="form3Example3">state</label>
                                                <input type="text" id="state" class="form-control" name="state"
                                                    required />

                                            </div>

                                            <div class="row mb-4">
                                                <div class="col">
                                                    <div class="form-outline">
                                                        <label class="form-label" for="form3Example1">Area</label>
                                                        <input type="text" id="form3Example1" class="form-control"
                                                            name="area" required />

                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <div class="form-outline">
                                                        <label class="form-label" for="form3Example2">Pincode</label>
                                                        <input type="text" id="pinCode" class="form-control"
                                                            name="pinCode" />

                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-outline mb-4">
                                                <label class="form-label" for="form3Example3">Building
                                                    Name</label>
                                                <input type="text" id="form3Example3" class="form-control"
                                                    name="buildingName" />

                                            </div>

                                            <div>
                                                <button type="button" class="btn btn-secondary"
                                                    data-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary">Submit</button>
                                            </div>

                                        </form>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="checkout__order">
                        <h4 class="order__title">Your order</h4>
                        <div class="checkout__order__products">Product <span>Total</span></div>
                        <ul class="checkout__total__products">
                            <% for( let i=0; i <Cart.items.length ; i++ ) { %>
                                <li>
                                    <% i %>
                                        <%=Cart.items[i].Product.name%> <span>₹<%=Cart.items[i].Price%></span>
                                </li>

                                <% } %>



                        </ul>
                        <ul class="checkout__total__all">
                            <li id="discount" style="display: none;">Discount <span id="afterDiscount"  >₹
                                </span></li>
                            <li>Total <span id="sumTotal">₹<%=Cart.cartTotal%></span></li>
                            <li>Total <span id="sumTotalhidden" style="display: none;">₹<%=Cart.cartTotal%></span></li>
                        </ul>
                       

                         <div class="flex-w flex-m m-r-20 m-tb-5">
                                    <input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text"
                                        id="couponInput" name="coupon" placeholder="Coupon Code">
                                    <button
                                        class="flex-c-m stext-101 cl2 size-118 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-5"
                                        type="button" onclick="couponManage(`<%=Cart.cartTotal %>`)">

                                        Apply coupon

                                    </button>
                                </div>
                        <div class="checkout__input__checkbox">
                            <label for="payment">
                                Cash On Delivery
                                
          
                                <input type="checkbox" id="payment" name="COD" value="COD">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="checkout__input__checkbox">
                            <label for="paypal">
                                Paypal
                                <input type="checkbox" id="paypal" name="paypal" value="paypal" required>
                                <span class="checkmark"></span>
                                <div id="paypal-button-container"></div>
                            </label>
                        </div>
                        <button type="button"
                            class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer"
                            onclick="placeOrder()">PLACE ORDER</button>
                    </div>
                </div>


            </div>
            </div>
        </section>
        <!-- Checkout Section End -->
        
       




        <!-- Footer Section End -->
      
        <!-- Search Begin -->
        <div class="search-model">
            <div class="h-100 d-flex align-items-center justify-content-center">
                <div class="search-close-switch">+</div>
                <form class="search-model-form">
                    <input type="text" id="search-input" placeholder="Search here.....">
                </form>
            </div>
        </div>
        <!-- Search End -->
        <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
        <!-- Js Plugins -->
        <script src="/checkOut/js/jquery-3.3.1.min.js"></script>
        <script src="/checkOut/js/bootstrap.min.js"></script>
        <script src="/checkOut/js/jquery.nice-select.min.js"></script>
        <script src="/checkOut/js/jquery.nicescroll.min.js"></script>
        <script src="/checkOut/js/jquery.magnific-popup.min.js"></script>
        <script src="/checkOut/js/jquery.countdown.min.js"></script>
        <script src="/checkOut/js/jquery.slicknav.js"></script>
        <script src="/checkOut/js/mixitup.min.js"></script>
        <script src="/checkOut/js/owl.carousel.min.js"></script>
        <script src="/checkOut/js/main.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.3.js"
            integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script> -->




           <!-- sweet alert cdn -->
       
    </body>

 
    <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalclientid %>" data-namespace="paypal_sdk"></script>
        <script src="https://code.jquery.com/jquery-3.6.3.js"
            integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
        <script>
 

            (function () {
                'use strict'

                window.addEventListener('load', function () {
                    // Fetch all the forms we want to apply custom Bootstrap validation styles to
                    var forms = document.getElementsByClassName('needs-validation')

                    // Loop over them and prevent submission
                    Array.prototype.filter.call(forms, function (form) {
                        form.addEventListener('submit', function (event) {
                            if (form.checkValidity() === false) {
                                event.preventDefault()
                                event.stopPropagation()
                            }
                            form.classList.add('was-validated')
                        }, false)
                    })
                }, false)
            }())
        </script>
        <script>

            function deleteAddress(AddressID) {
                
Swal.fire({
  title: 'Do you want to save the changes?',
  showDenyButton: true,
  showCancelButton: true,
  confirmButtonText: 'Yes',
  denyButtonText: 'No',
  customClass: {
    actions: 'my-actions',
    cancelButton: 'order-1 right-gap',
    confirmButton: 'order-2',
    denyButton: 'order-3',
  }
}).then((result) => {
  if (result.isConfirmed) {
    Swal.fire('Saved!', '', 'success')
    $.ajax({
                            url: `/address?dlt=${AddressID}`,
                            method: "delete",

                            success: ((res) => {
                                console.log(111111);
                                if (res.status == true) {
                                    location.reload()
                                }
                            })

                        })
  } else if (result.isDenied) {
    Swal.fire('Changes are not saved', '', 'info')
  }
})





// function editAddress(addressID) {

// console.log(12121212121121212121212121);
// console.log(addressID);

// $("#editAddress").submit((e) => {
//   e.preventDefault()
//   $.ajax({
//     url: `/editAddres?ID=${addressID}`,
//     method: "put",
//     data: $("#editAddress").serialize(),
//     success: ((res) => {

//     })
//   })
// })

// }

                // swal({
                //     title: "Are you sure?",
                //     text: "Once deleted, you will not be able to recover this imaginary file!",
                //     icon: "warning",
                //     buttons: true,
                //     dangerMode: true,
                // })
                //     .then((willDelete) => {
                //         $.ajax({
                //             url: `/address?dlt=${AddressID}`,
                //             method: "delete",

                //             success: ((res) => {
                //                 console.log(111111);
                //                 if (res.status == true) {
                //                     location.reload()
                //                 }
                //             })

                //         })
                //         if (willDelete) {
                //             swal("Poof! Your imaginary file has been deleted!", {
                //                 icon: "success",
                //             });
                //         } else {
                //             swal("Your imaginary file is safe!");
                //         }
                //     });


            }
        </script>

        <script>
        const  name=document.getElementById("fullName")	
const phone=document.getElementById("phone")
const state=document.getElementById("state" )
const pin=document.getElementById("pinCode")
const form=document.getElementById("addform")
const errorMessage=document.getElementById("error")
      console.log(name.value,121121212121212);
      let message=[]
      form.addEventListener("submit",(e)=>{
        console.log(121212121212);
if(name.value==""||name==null){
        message.push("Name is required !!!!!!!!")
        console.log(name.value+1212121122);
}
else if(phone.value==""||phone==null||phone.value.length<10){
  message.push("Phone number is Not valid ! ! ! ! ! !")
}
else if(pin.value.length<5){
  message.push("Pincode is not Valid ! ! ! ! !")
}
if(message.length>0){
    e.preventDefault()
  console.log("Not valid ");
  errorMessage.style.cssText="inline"
  errorMessage.innerText=message.join("")
}
      })




            function placeOrder() {
                let Paypal = $('input[type="checkbox"][name="paypal"]:checked').val();
                let COD = $('input[type="checkbox"][name="COD"]:checked').val();
                let addressID = $('input[type="radio"][name="address"]:checked').val();
                 let amount=document.getElementById("sumTotalhidden").innerHTML
                 let  Amount=amount.substring(1)
                
                console.log(addressID, COD, Paypal,amount);
                if (!addressID) {
                    Swal.fire('Choose Any address')
                }
                else if (!Paypal && !COD) {
                    Swal.fire('Please Select Payment Method')
                }
                else {



                    $.ajax({
                        url: `/placeOrder?addresID=${addressID}&COD=${COD}&Paypal=${Paypal}&amount=${Amount}`,
                        method: "post",
                        success: ((res) => {

                            if (res.status == true) {
                               
                                location.href = "/successPage"
                            }
                           else if(res.paypal){
                           
                            console.log(res.amount);
                            paypal_sdk.Buttons({
                            createOrder: function () {
                                return fetch("/create-order", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        items: [
                                            {
                                                id: 1,
                                                amount:res.amount,
                                            },
                                            { id: 2, amount:res.amount},
                                        ],
                                    }),
                                }).then(res => {
                                    if (res.ok) return res.json()
                                    console.log(res.json());
                                    return res.json().then(json => Promise.reject(json))
                                }).then(({ id }) => {
                                    console.log("pp");
                                    return id
                                }).catch(e => {
                                    console.error(e)
                                })
                            },
                            onApprove: function (data, actions) {
                                console.log(data);
                                console.log(actions);
                                return actions.order.capture().then(function (details) {
                                    verifyPayment(res);
                                   
                                })
                            }
                        }).render('#paypal-button-container');
                           }

                        })
                    })
                }
            }

       function verifyPayment(res){
        $.ajax({
         url: "/verifyPayment",
         method:"get",
         success:((res)=>{
             if(res.order){
                location.href = "/successPage"
             }
         })



        })

       }
         
       function couponManage(total) {
                        let couponCode = document.getElementById("couponInput").value;
                        let amount=document.getElementById("sumTotal")
                        console.log( amount,111111111111111);
                        console.log(couponCode);
                        $.ajax({
                            url: `/couponChecking?total=${total}`,
                            method: "post",
                            data: { coupon: couponCode },
                            success: ((res) => {
                                if (res.status) {
                                    console.log(res.totalPrice);
                                    document.getElementById("discount").style.display = "inline"
                                    document.getElementById("afterDiscount").innerHTML = "₹"+res.discount
                                    document.getElementById("sumTotal").innerHTML =  "₹"+res.totalPrize
                                    document.getElementById("sumTotal").value=res.totalPrize
                                    document.getElementById("sumTotalhidden").innerHTML =  "₹"+res.totalPrize
                                     
                                }
                            
                                else {
                                    console.log(res.message + 1111111);
                                    document.getElementById("couponInput").value = res.message
                                }
                            })
                        })

                    }


        </script>
     <%- include("partials/userFooter.ejs") -%>